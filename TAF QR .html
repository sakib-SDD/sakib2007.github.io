<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TAKAMOL AUTO FILL — FINAL QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body { font-family: 'Times New Roman', serif; padding: 20px; background: #f5f5f5; transition: background 0.3s, color 0.3s; }
    h1 { text-align: center; margin-bottom: 30px; }
    .container { display: flex; flex-wrap: wrap; gap: 30px; }
    .panel { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: background 0.3s, color 0.3s; }
    .common-info label { display: block; margin-top: 10px; font-weight: bold; }
    .common-info input, .common-info select { width: 100%; padding: 6px; margin-top: 4px; border-radius: 5px; border: 1px solid #ccc; }
    .upload-box { margin-top: 20px; border: 2px dashed #555; border-radius: 10px; padding: 20px; text-align: center; }
    #candidatesTable { border-collapse: collapse; width: 95%; margin-top: 10px; font-size: 14px; }
    #candidatesTable th, #candidatesTable td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    #candidatesTable th { background: #e0f2e9; }
    #candidatesTable thead th { position: sticky; top: 0; z-index: 5; }
    #candidatesTable tbody tr:nth-child(odd) { background: #d3d3d3; }
    #candidatesTable tbody tr:nth-child(even) { background: #ffffff; }
    .btn { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; background: #28a745 !important; color: #fff; border: none; border-radius: 8px; font-size: 16px; transition: background 0.3s; }
    .btn:hover { background: #218838 !important; }
    #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); color: #fff; font-size: 18px; text-align: center; padding-top: 15%; z-index: 1000; }
    #duplicatePopup { display: none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border: 2px solid #333; border-radius: 10px; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center; }
    #duplicatePopup button { margin-top: 10px; padding: 6px 14px; border: none; background: #28a745; color: #fff; border-radius: 6px; cursor: pointer; }
    body.dark { background: #1e1e1e; color: #e0e0e0; }
    body.dark .panel { background: #2c2c2c; color: #fff; }
    body.dark #candidatesTable th { background: #444 !important; }
    body.dark #candidatesTable td { background: #333; color: #eee; }
  </style>
</head>
<body>

<h1>
  TAKAMOL AUTO FILL — FINAL QR
  <button class="btn" id="themeToggle" style="width:auto;float:right;margin-top:-10px;">🌙 Dark Mode</button>
</h1>

<div class="container">
  <!-- LEFT PANEL -->
  <div class="panel">
    <div class="common-info">
      <label>Ticket No.:</label><input type="text" id="ticketNo" />
      <label>Date:</label><input type="date" id="date" />
      <label>CBT Start Time:</label><input type="time" id="cbtStartTime" />
      <label>Practical Start Time:</label><input type="time" id="practicalStartTime" />
      <label>Occupation Name:</label>
      <select id="occupationName">
        <option>Construction Worker</option>
        <option>Barber</option>
        <option>Load and Unload Worker</option>
        <option>Constructing Worker</option>
        <option>Street Clean Worker</option>
        <option>Office and Facilities Cleaning Worker</option>
      </select>
    </div>

    <div class="upload-box">
      <strong>Select Main Folder (with candidate subfolders)</strong><br />
      <input type="file" id="folderInput" webkitdirectory directory multiple />
    </div>

    <div class="upload-box">
      <strong>Select QR Folder</strong><br />
      <input type="file" id="qrFolderInput" webkitdirectory directory multiple />
    </div>

    <button class="btn" id="scanQRButton">Scan QR Codes</button>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel" style="flex:1;">
    <div style="margin:10px 0;">
      <button class="btn" onclick="markAllType('Not Applicable')">Mark All as Not Applicable</button>
      <button class="btn" onclick="markAllType('Easy')">Mark All as Easy</button>
    </div>

    <table id="candidatesTable">
      <thead>
        <tr><th>#</th><th>Name</th><th>Passport</th><th>Type</th><th>Task No.</th><th>Reservation ID</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn" id="generateButton">Generate All PDFs</button>
    <div id="timeEstimate" style="margin-top:8px;font-weight:bold;color:#555;"></div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div style="margin-bottom:10px;">Generating PDFs...</div>
  <progress id="progressBar" value="0" max="100" style="width:80%;height:20px;"></progress>
  <div id="progressCount" style="margin-top:8px;"></div>
</div>

<!-- Duplicate Popup -->
<div id="duplicatePopup">
  <div id="duplicateMessage"></div>
  <button onclick="document.getElementById('duplicatePopup').style.display='none'">Ignore</button>
</div>

<script>
(function() {
  const folderInput = document.getElementById('folderInput');
  const qrFolderInput = document.getElementById('qrFolderInput');
  const scanQRButton = document.getElementById('scanQRButton');
  const tbody = document.querySelector('#candidatesTable tbody');
  const generateButton = document.getElementById('generateButton');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const progressCount = document.getElementById('progressCount');
  const progressBar = document.getElementById('progressBar');
  const duplicatePopup = document.getElementById('duplicatePopup');
  const duplicateMessage = document.getElementById('duplicateMessage');
  const timeEstimate = document.getElementById('timeEstimate');

  let allFiles = [], candidates = [];

  // ✅ Candidate folder load
  folderInput.addEventListener('change', (ev) => {
    allFiles = Array.from(ev.target.files);
    const groups = {};
    allFiles.forEach((f) => {
      const parts = f.webkitRelativePath.split('/');
      if (parts.length >= 2) {
        const sub = parts[1];
        (groups[sub] = groups[sub] || []).push(f);
      }
    });

    candidates = Object.keys(groups).map((name) => ({ name, files: groups[name] }));

    // Missing photo check
    let missingReport = "";
    candidates.forEach(c => {
      const found = {};
      c.files.forEach(f => {
        const fname = f.name.toLowerCase();
        if (fname.startsWith("1.")) found[1] = true;
        if (fname.startsWith("2.")) found[2] = true;
        if (fname.startsWith("3.")) found[3] = true;
        if (fname.startsWith("4.")) found[4] = true;
      });
      [1,2,3,4].forEach(n => {
        if (!found[n]) missingReport += `Folder "${c.name}" missing photo ${n}\n`;
      });
    });
    if (missingReport) alert("⚠️ Missing Photos:\n\n" + missingReport);

    // Populate table
    tbody.innerHTML = '';
    candidates.forEach((c, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td><input type="text" value="${c.name}" readonly style="min-width:120px;width:auto;"></td>
        <td><input type="text" class="passport" style="width:120px;" /></td>
        <td>
          <select class="type" style="width:120px;">
            <option>Hard</option>
            <option>Moderate</option>
            <option>Easy</option>
            <option>Not Applicable</option>
          </select>
        </td>
        <td><input type="text" class="taskNo" style="width:100px;" /></td>
        <td><input type="text" class="reservationId" style="width:130px;" /></td>
      `;
      tbody.appendChild(tr);
    });
    attachDuplicateCheckers();
  });

  // ✅ Duplicate check
  function attachDuplicateCheckers() {
    tbody.querySelectorAll('.passport').forEach(input => {
      input.addEventListener('input', () => checkDuplicate('passport'));
    });
    tbody.querySelectorAll('.reservationId').forEach(input => {
      input.addEventListener('input', () => checkDuplicate('reservationId'));
    });
  }
  function checkDuplicate(type) {
    const seen = {};
    Array.from(tbody.rows).forEach(row => {
      const name = row.cells[1].querySelector('input').value;
      const val = row.querySelector('.' + type).value.trim();
      if (val) {
        if (seen[val]) {
          duplicateMessage.innerHTML = `Duplicate ${type.toUpperCase()}!<br>Name 1: ${seen[val]}<br>Name 2: ${name}<br>Value: ${val}`;
          duplicatePopup.style.display = 'block';
        } else {
          seen[val] = name;
        }
      }
    });
  }

  // ✅ QR Folder Scan
  scanQRButton.addEventListener('click', async () => {
    const files = Array.from(qrFolderInput.files);
    if (files.length === 0) return alert("Please select a QR folder!");
    for (const file of files) {
      const dataUrl = await fileToDataURL(file);
      const img = await loadImage(dataUrl);
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width; canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
      if (qrCode) {
        const text = qrCode.data;
        const nameMatch = text.match(/Candidate Name\s*:\s*(.*)/i);
        const passMatch = text.match(/Passport Number\s*:\s*(.*)/i);
        const resMatch = text.match(/Reservation ID\s*:\s*(.*)/i);
        const name = nameMatch ? nameMatch[1].trim() : "";
        const passport = passMatch ? passMatch[1].trim() : "";
        const reservation = resMatch ? resMatch[1].trim() : "";
        if (name) {
          const row = findRowByName(name);
          if (row) {
            if (passport) row.querySelector(".passport").value = passport;
            if (reservation) row.querySelector(".reservationId").value = reservation;
          }
        }
      }
    }
    alert("✅ QR Scan complete and data filled.");
  });

  function findRowByName(name) {
    const norm = s => s.replace(/\s+/g, "").toLowerCase();
    for (const row of tbody.rows) {
      const candidateName = row.cells[1].querySelector("input").value;
      if (norm(candidateName) === norm(name)) return row;
    }
    return null;
  }
  function fileToDataURL(file) {
    return new Promise((res) => {
      const reader = new FileReader();
      reader.onload = e => res(e.target.result);
      reader.readAsDataURL(file);
    });
  }
  function loadImage(src) {
    return new Promise((res) => {
      const img = new Image();
      img.onload = () => res(img);
      img.src = src;
    });
  }

  // ✅ PDF Generation
  generateButton.addEventListener('mouseenter', () => {
    if (candidates.length > 0) {
      const estimateSec = candidates.length * 1.5;
      const mins = Math.floor(estimateSec / 60);
      const secs = Math.floor(estimateSec % 60);
      timeEstimate.textContent = `Estimated: ${mins>0?mins+"m ":""}${secs}s for ${candidates.length} candidates.`;
    } else timeEstimate.textContent = "";
  });

  generateButton.addEventListener('click', async () => {
    if (candidates.length === 0) return alert("No candidates loaded!");
    const { jsPDF } = window.jspdf;
    const common = {
      ticketNo: document.getElementById('ticketNo').value,
      date: document.getElementById('date').value,
      cbtTime: document.getElementById('cbtStartTime').value,
      pracTime: document.getElementById('practicalStartTime').value,
      occupation: document.getElementById('occupationName').value
    };
    loadingOverlay.style.display = 'block';
    progressCount.textContent = `0 / ${candidates.length}`;
    progressBar.value = 0;
    for (let i = 0; i < candidates.length; i++) {
      const row = tbody.rows[i];
      const cand = {
        name: row.cells[1].querySelector('input').value,
        passport: row.cells[2].querySelector('input').value,
        type: row.cells[3].querySelector('select').value,
        taskNo: row.cells[4].querySelector('input').value,
        reservationId: row.cells[5].querySelector('input').value,
      };
      const imgs = {};
      ['1', '2', '3', '4'].forEach((n) => {
        const f = candidates[i].files.find((f) => f.name.toLowerCase().startsWith(n + '.'));
        if (f) imgs[n] = f;
      });
      const doc = new jsPDF('p', 'in', 'a4');
      doc.setFont('times');
      doc.setFontSize(20);
      doc.text('Photos of Exam Tracker', 2.6, 1);
      doc.setFontSize(12);
      const data = [
        [`Test Centre: Bangladesh German TTC`,`Occupation: ${common.occupation}`,`Date: ${common.date}`],
        [`Candidate Name: ${cand.name}`,`Passport: ${cand.passport}`,`Ticket No.: ${common.ticketNo}`],
        [`Reservation ID: ${cand.reservationId}`,`Practical Task No.: ${cand.taskNo}`,`Type: ${cand.type}`],
        [`CBT Start: ${common.cbtTime}`,`Practical Start: ${common.pracTime}`,``],
      ];
      doc.autoTable({ startY: 1.5, body: data });
      const pw = 2.9, ph = 3.9, gap = 0.3, ox = 1.2;
      const pos = [
        { x: ox, y: 3.5 },
        { x: ox + pw + gap, y: 3.5 },
        { x: ox, y: 3.5 + ph + gap },
        { x: ox + pw + gap, y: 3.5 + ph + gap },
      ];
      await Promise.all(Object.entries(imgs).map(([n, file], idx) =>
        new Promise((res) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            doc.addImage(e.target.result, 'JPEG', pos[idx].x, pos[idx].y, pw, ph);
            res();
          };
          reader.readAsDataURL(file);
        })
      ));
      doc.save(`${cand.name}.pdf`);
      progressCount.textContent = `${i + 1} / ${candidates.length}`;
      progressBar.value = Math.round(((i + 1) / candidates.length) * 100);
      await new Promise(r => setTimeout(r, 300));
    }
    loadingOverlay.style.display = 'none';
  });

  // ✅ Dark/Light toggle
  document.getElementById('themeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark');
    const btn = document.getElementById('themeToggle');
    btn.textContent = document.body.classList.contains('dark') ? "☀️ Light Mode" : "🌙 Dark Mode";
  });

  // ✅ Bulk mark
  window.markAllType = function(value) {
    document.querySelectorAll('#candidatesTable .type').forEach(sel => { sel.value = value; });
  };

})();
</script>
</body>
</html>
